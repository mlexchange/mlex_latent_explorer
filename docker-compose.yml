version: "3"

services:

    prefect:
    image: prefecthq/prefect:2.14-python3.11
    command: prefect server start
    environment:
      - PREFECT_SERVER_API_HOST=0.0.0.0
      - PREFECT_API_DATABASE_CONNECTION_URL=postgresql+asyncpg://${PREFECT_DB_USER}:${PREFECT_DB_PW}@prefect_db:5432/${PREFECT_DB_NAME} # Needed if using postgres and not sqlite
      # - PREFECT_UI_API_URL=https://localhost/api. needed if nginx is handling ssl termination
      - PREFECT_LOGGING_LEVEL=DEBUG
    ports:
      - 4200:4200
    depends_on:
      - prefect_db
    networks:
      mle_net:

  prefect_db:
    image: postgres:14.5-alpine
    environment:
      - POSTGRES_USER=${PREFECT_DB_USER}
      - POSTGRES_PASSWORD=${PREFECT_DB_PW}
      - POSTGRES_DB=${PREFECT_DB_NAME}
    volumes:
      - ./data/prefect_db:/var/lib/postgresql/data:rw
    restart: unless-stopped
    networks:
      mle_net:

  front-end:
    restart: "unless-stopped"
    container_name: "latentxp"
    build:
      context: "."
      dockerfile: "docker/Dockerfile"
    mem_limit: 2g
    environment:
      DATA_DIR: "${PWD}/data/"
      # USER: "$USER"
    volumes:
      - ./data:/app/work/data
      - ./src:/app/work/src
    ports:
      - "8070:8070"
    # networks:
    #   - computing_api_default  
    networks:
      mle_net:

# networks:
#   computing_api_default:
#     external: true

networks:
  mle_net:
    driver: bridge

# env file: set up pwd